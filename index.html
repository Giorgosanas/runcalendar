<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RunCalendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg: #0b1220;
      --card: #020617;
      --border: #1f2937;
      --primary: #3b82f6;
      --danger: #f97373;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --radius: 16px;
      --shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
      --bg-grad-highlight: rgba(37,99,235,0.3);
    }

    body[data-theme="light"] {
      --bg: #f5f5f5;
      --card: #ffffff;
      --border: #e0e0e0;
      --primary: #2563eb;
      --danger: #ef4444;
      --text: #111827;
      --text-muted: #6b7280;
      --shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
      --bg-grad-highlight: rgba(59,130,246,0.25);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, var(--bg-grad-highlight), transparent 60%), var(--bg);
      color: var(--text);
      transition: background 0.25s ease, color 0.25s ease;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.7rem 1rem 0.9rem;
      background: linear-gradient(135deg, #020617, #020617);
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 4px 16px rgba(0,0,0,0.6);
    }

    body[data-theme="light"] header {
      background: linear-gradient(135deg, #1d4ed8, #1e3a8a);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    header h1 {
      font-size: 1.05rem;
      margin: 0;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    header button {
      border: none;
      padding: 0.3rem 0.6rem;
      cursor: pointer;
      border-radius: 999px;
      font-size: 0.8rem;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
    }

    header button:hover {
      background: rgba(31,41,55,0.95);
    }

    #monthLabel {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .theme-toggle {
      font-size: 0.8rem;
      border-radius: 999px;
      padding: 0.3rem 0.7rem;
    }

    .theme-toggle::after {
      content: attr(data-label);
      margin-left: 0.25rem;
    }

    .auth-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }

    .auth-bar input {
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
    }

    body[data-theme="light"] .auth-bar input {
      background: rgba(255,255,255,0.18);
      border-color: rgba(15,23,42,0.3);
      color: #0f172a;
    }

    .auth-bar button {
      border-radius: 999px;
      border: none;
      padding: 0.25rem 0.6rem;
      font-size: 0.8rem;
      cursor: pointer;
      background: var(--primary);
      color: #ffffff;
    }

    .auth-bar .secondary {
      background: rgba(15,23,42,0.9);
    }

    .auth-bar .secondary:hover {
      background: rgba(31,41,55,0.95);
    }

    .sync-status {
      font-size: 0.75rem;
      opacity: 0.85;
    }

    main {
      padding: 0.8rem;
      max-width: 1100px;
      margin: 0 auto 1.2rem;
    }

    .toolbar {
      margin: 0.8rem 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }

    .toolbar-group {
      background: rgba(2,6,23,0.9);
      border-radius: 999px;
      padding: 0.35rem 0.7rem;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      backdrop-filter: blur(10px);
    }

    body[data-theme="light"] .toolbar-group {
      background: rgba(255,255,255,0.95);
    }

    .toolbar-group label {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .toolbar-group select,
    .toolbar-group input[type="date"] {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 0.2rem 0.4rem;
      font-size: 0.8rem;
      background: var(--card);
      color: var(--text);
    }

    .toolbar-group button {
      border: none;
      border-radius: 999px;
      padding: 0.25rem 0.6rem;
      font-size: 0.78rem;
      cursor: pointer;
      background: var(--primary);
      color: #fff;
      white-space: nowrap;
    }

    .calendar-card {
      background: rgba(2,6,23,0.95);
      border-radius: var(--radius);
      padding: 0.8rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
    }

    body[data-theme="light"] .calendar-card {
      background: rgba(255,255,255,0.95);
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .weekday {
      font-weight: 600;
      text-align: center;
      padding: 0.3rem 0;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .day {
      background: var(--card);
      border-radius: 12px;
      padding: 0.3rem;
      min-height: 74px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      border: 1px solid var(--border);
      font-size: 0.75rem;
      position: relative;
      transition: transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease;
    }

    .day:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(0,0,0,0.35);
      border-color: var(--primary);
    }

    .day-number {
      font-weight: 600;
      margin-bottom: 0.2rem;
      font-size: 0.85rem;
    }

    .run-tag {
      padding: 0.12rem 0.4rem;
      border-radius: 999px;
      font-size: 0.7rem;
      display: inline-block;
      margin-bottom: 0.15rem;
      white-space: nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .type-Rest      { background: #4b5563; color: #e5e7eb; }
    .type-Easy      { background: #2563eb; color: #e5e7eb; }
    .type-Tempo     { background: #f97316; color: #111827; }
    .type-Intervals { background: #facc15; color: #111827; }
    .type-Long      { background: #22c55e; color: #052e16; }

    body[data-theme="light"] .type-Rest      { background: #e5e7eb; color: #111827; }
    body[data-theme="light"] .type-Easy      { background: #bfdbfe; color: #1d4ed8; }
    body[data-theme="light"] .type-Tempo     { background: #fed7aa; color: #9a3412; }
    body[data-theme="light"] .type-Intervals { background: #fef08a; color: #854d0e; }
    body[data-theme="light"] .type-Long      { background: #bbf7d0; color: #166534; }

    .day-distance {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .day-distance span.done {
      font-weight: 600;
      color: var(--primary);
    }

    .today {
      border: 2px solid var(--primary);
    }

    .today::after {
      content: "Today";
      position: absolute;
      top: 4px;
      right: 6px;
      font-size: 0.6rem;
      color: var(--primary);
      opacity: 0.9;
    }

    .completed-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--primary);
      position: absolute;
      bottom: 4px;
      right: 6px;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 20;
    }

    .modal-backdrop.show { display: flex; }

    .modal {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1rem 1.1rem;
      width: 100%;
      max-width: 420px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .modal h2 {
      margin: 0 0 0.3rem;
      font-size: 1rem;
    }

    #modalDate {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.6rem;
    }

    .form-group {
      margin-bottom: 0.5rem;
      display: flex;
      flex-direction: column;
      font-size: 0.85rem;
    }

    .form-group label { margin-bottom: 0.15rem; }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.35rem 0.45rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
      background: var(--card);
      color: var(--text);
    }

    textarea { resize: vertical; }

    .help-text {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }

    .form-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.7rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.4rem 0.7rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: #4b5563; color: #e5e7eb; }
    .btn-danger   { background: var(--danger); color: white; }

    body[data-theme="light"] .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1.6fr);
      gap: 0.8rem;
      margin-top: 1rem;
    }

    .stats {
      background: rgba(2,6,23,0.95);
      border-radius: var(--radius);
      padding: 0.7rem 0.9rem;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
    }

    body[data-theme="light"] .stats {
      background: rgba(255,255,255,0.95);
    }

    .stats h3 {
      margin: 0 0 0.5rem;
      font-size: 0.9rem;
    }

    .chart-container {
      margin-top: 0.5rem;
      background: rgba(15,23,42,0.7);
      border-radius: 12px;
      padding: 0.4rem;
    }

    body[data-theme="light"] .chart-container {
      background: rgba(249,250,251,0.9);
    }

    #coachAdvice {
      margin-top: 0.45rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    #streakCurrent, #streakBest {
      font-weight: 600;
    }

    .stats-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.25rem;
    }

    .stats-row span.label {
      color: var(--text-muted);
    }

    .stats-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
    }

    .stats-header-row select {
      font-size: 0.75rem;
      border-radius: 999px;
      padding: 0.15rem 0.35rem;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text-muted);
    }

    #shoeSummary, #sleepFatigueSummary {
      margin-top: 0.4rem;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    #shoeSummary ul {
      padding-left: 1.1rem;
      margin: 0.2rem 0 0;
    }

    #shoeSummary li {
      margin-bottom: 0.1rem;
    }

    .fab-today {
      position: fixed;
      right: 1rem;
      bottom: 1rem;
      border-radius: 999px;
      padding: 0.6rem 0.9rem;
      font-size: 0.85rem;
      border: none;
      background: var(--primary);
      color: #fff;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      display: none;
      z-index: 15;
    }

    /* MOBILE LAYOUT POLISH */
@media (max-width: 700px) {

  /* a bit more breathing room around the whole page */
  main {
    padding: 0.9rem 0.9rem 1.4rem;
  }

  /* cards: bigger + spaced apart */
  .card {
    width: 100%;
    max-width: 100%;
    padding: 1rem 1.1rem 1.2rem;
    margin-top: 0.8rem;
  }

  /* extra gap between consecutive cards */
  .card + .card {
    margin-top: 1rem;
  }

  /* vertical spacing between calendar + stats area */
  .calendar-wrapper {
    margin-bottom: 1.2rem;
  }

  /* if your stats section uses a grid, make it single-column */
  .stats-grid {
    display: grid;
    grid-template-columns: minmax(0, 1fr);
    gap: 1rem;
  }

  /* keep existing tweaks you already added */
  .calendar {
    gap: 2px;
  }

  .day {
    min-height: 70px;
    padding: 0.35rem;
  }

  .weekday {
    font-size: 0.7rem;
  }

  /* header not sticky on mobile */
  header {
    position: static;
    top: auto;
    box-shadow: none;
  }

  /* auth bar stacked full-width */
  .auth-bar {
    flex-direction: column;
    align-items: stretch;
    gap: 0.5rem;
  }

  .auth-bar input,
  .auth-bar button,
  .auth-bar .sync-status {
    width: 100%;
  }

  /* toolbar stacked with space */
  .toolbar {
    flex-direction: column;
    align-items: stretch;
    gap: 0.75rem;
  }

  .toolbar-group {
    border-radius: 12px;
    width: 100%;
    flex-direction: column;
    align-items: stretch;
    gap: 0.5rem;
  }

  .toolbar-group select,
  .toolbar-group input,
  .toolbar-group button {
    width: 100%;
  }

  /* floating Today button */
  .fab-today {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }
}

  </style>
</head>
<body data-theme="dark">
<header>
  <div class="header-top">
    <h1>RUNCALENDAR</h1>
    <div class="header-controls">
      <button id="prevMonthBtn">&lt;</button>
      <div id="monthLabel"></div>
      <button id="nextMonthBtn">&gt;</button>
      <button id="themeToggleBtn" class="theme-toggle" data-label="Light">ðŸŒž</button>
    </div>
  </div>

  <div class="auth-bar">
    <input id="loginEmail" type="email" placeholder="Email" />
    <input id="loginPassword" type="password" placeholder="Password" />
    <button id="loginBtn" class="secondary">Log in</button>
    <button id="signupBtn">Sign up</button>
    <button id="logoutBtn" style="display:none;" class="secondary">Log out</button>
    <span id="authStatus" class="sync-status">Not logged in</span>
    <span id="shareCode" class="sync-status"></span>
    <span id="syncStatus" class="sync-status"></span>
  </div>
</header>

<main>
  <!-- Training plan + color theme toolbar -->
  <div class="toolbar">
    <div class="toolbar-group">
      <label for="planSelect">Plan</label>
      <select id="planSelect">
        <option value="none">None</option>
        <option value="5k-beginner">5K Beginner</option>
        <option value="10k-build">10K Build</option>
        <option value="hm-12w">Half Marathon</option>
        <option value="marathon">Marathon</option>
      </select>
      <label for="planStartDate">Start</label>
      <input type="date" id="planStartDate" />
      <label for="planRaceDate">Race</label>
      <input type="date" id="planRaceDate" />
      <label for="planDaysPerWeek">Days/wk</label>
      <select id="planDaysPerWeek">
        <option value="3">3</option>
        <option value="4" selected>4</option>
        <option value="5">5</option>
        <option value="6">6</option>
      </select>
      <button id="applyPlanBtn">Apply</button>
      <button id="clearPlanBtn" style="background:var(--danger);color:white;">Clear plan</button>
      <button id="forceClearPlanBtn" style="background:transparent;border:1px solid var(--danger);color:var(--danger);">
        Force clear
      </button>
    </div>

    <div class="toolbar-group">
      <label for="colorThemeSelect">Theme</label>
      <select id="colorThemeSelect">
        <option value="default">Default</option>
        <option value="ocean">Ocean</option>
        <option value="sunset">Sunset</option>
        <option value="forest">Forest</option>
        <option value="neon">Neon</option>
      </select>
    </div>

    <div class="toolbar-group">
      <label for="friendCodeInput">Friend code</label>
      <input id="friendCodeInput" type="text" placeholder="paste code" />
      <button id="viewFriendBtn">View</button>
      <button id="backToMeBtn">Me</button>
    </div>
  </div>

  <div class="calendar-card">
    <div class="calendar" id="calendar"></div>
  </div>

  <div class="stats-grid">
    <!-- Week summary + streaks + PDF + shoes + sleep -->
    <div class="stats" id="statsBox">
      <h3>This Week</h3>
      <div class="stats-row">
        <span class="label">Planned km</span>
        <span id="statsPlannedKm">0</span>
      </div>
      <div class="stats-row">
        <span class="label">Done km</span>
        <span id="statsDoneKm">0</span>
      </div>
      <div class="stats-row">
        <span class="label">Runs logged</span>
        <span id="statsRuns">0</span>
      </div>
      <div class="stats-row" style="margin-top:0.4rem;">
        <span class="label">Current streak</span>
        <span id="streakCurrent">0 days</span>
      </div>
      <div class="stats-row">
        <span class="label">Best streak</span>
        <span id="streakBest">0 days</span>
      </div>
      <div id="sleepFatigueSummary"></div>
      <div id="shoeSummary"></div>
      <button class="btn btn-primary" id="pdfBtn" style="margin-top:0.6rem;">Download month report (PDF)</button>
    </div>

    <!-- Charts + coach -->
    <div class="stats" id="analyticsBox">
      <div class="stats-header-row">
        <h3>Progress & Coach</h3>
        <div>
          <label for="coachLangSelect" style="font-size:0.75rem;color:var(--text-muted);margin-right:0.2rem;">Coach lang</label>
          <select id="coachLangSelect">
            <option value="en">EN</option>
            <option value="gr">GR</option>
          </select>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="weekDistanceCanvas" height="120"></canvas>
      </div>
      <div class="chart-container" style="margin-top:0.45rem;">
        <canvas id="weekPaceCanvas" height="120"></canvas>
      </div>
      <div class="chart-container" style="margin-top:0.45rem;">
        <canvas id="rpePaceCanvas" height="120"></canvas>
      </div>
      <p id="coachAdvice"></p>
    </div>
  </div>
</main>

<button class="fab-today" id="todayFab">ðŸ“… Today</button>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <h2>Edit Run</h2>
    <p id="modalDate"></p>

    <div class="form-group">
      <label>Type</label>
      <select id="runType">
        <option value="Rest">Rest</option>
        <option value="Easy">Easy</option>
        <option value="Tempo">Tempo</option>
        <option value="Intervals">Intervals</option>
        <option value="Long">Long</option>
      </select>
    </div>

    <div class="form-group">
      <label>Workout template (optional)</label>
      <select id="workoutTemplate">
        <option value="">None</option>
        <option value="4x400_1k_tempo">4Ã—400m + 1 km tempo</option>
        <option value="6x800_vo2">6Ã—800m VOâ‚‚</option>
        <option value="tempo20">20 min tempo</option>
      </select>
      <div class="help-text" id="templateHint"></div>
    </div>

    <div class="form-group">
      <label>Planned distance (km)</label>
      <input type="number" step="0.1" id="plannedDistance" />
    </div>
    <div class="form-group">
      <label>Planned pace (min/km)</label>
      <input type="text" id="plannedPace" placeholder="e.g. 6:00 or 5:30â€“5:40" />
    </div>
    <div class="form-group">
      <label>Actual distance (km)</label>
      <input type="number" step="0.1" id="actualDistance" />
    </div>
    <div class="form-group">
      <label>Actual pace (min/km)</label>
      <input type="text" id="actualPace" placeholder="e.g. 5:50" />
    </div>
    <div class="form-group">
      <label>How it felt (RPE 1â€“10)</label>
      <input type="number" min="1" max="10" id="rpe" />
    </div>
    <div class="form-group">
      <label>Shoe</label>
      <input type="text" id="shoe" placeholder="e.g. Pegasus 41" list="shoeOptions" />
      <datalist id="shoeOptions"></datalist>
    </div>
    <div class="form-group">
      <label>Sleep quality (1â€“10)</label>
      <input type="number" min="1" max="10" id="sleep" />
    </div>
    <div class="form-group">
      <label>Fatigue (1â€“10)</label>
      <input type="number" min="1" max="10" id="fatigue" />
    </div>
    <div class="form-group">
      <label>Notes (route, weather, splitsâ€¦)</label>
      <textarea id="notes" rows="3"></textarea>
    </div>

    <div class="form-actions">
      <button class="btn btn-danger" id="deleteBtn">Clear</button>
      <div>
        <button class="btn btn-secondary" id="closeBtn">Cancel</button>
        <button class="btn btn-primary" id="saveBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ðŸ”§ Your Supabase config
  const SUPABASE_URL = "https://bdhqktzwchswzwlmrpmd.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkaHFrdHp3Y2hzd3p3bG1ycG1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzY2NTUsImV4cCI6MjA4MDYxMjY1NX0.WAElPc6oei5haF1qqgqaEKmKrb82g4GYTQ6m-uVXdPk";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const { jsPDF } = window.jspdf;

  const COLOR_THEMES = {
    default: {
      '--primary': '#3b82f6',
      '--bg-grad-highlight': 'rgba(37,99,235,0.3)'
    },
    ocean: {
      '--primary': '#0ea5e9',
      '--bg-grad-highlight': 'rgba(14,165,233,0.35)'
    },
    sunset: {
      '--primary': '#f97316',
      '--bg-grad-highlight': 'rgba(249,115,22,0.35)'
    },
    forest: {
      '--primary': '#22c55e',
      '--bg-grad-highlight': 'rgba(34,197,94,0.35)'
    },
    neon: {
      '--primary': '#a855f7',
      '--bg-grad-highlight': 'rgba(168,85,247,0.4)'
    }
  };

  // Structured workout templates
  const WORKOUT_TEMPLATES = {
    '4x400_1k_tempo': {
      name: '4Ã—400m + 1 km tempo',
      type: 'Intervals',
      totalDistance: 1 + 4 * 0.4 + 1 + 1, // warmup + reps + tempo + cooldown
      pace: 'See parts',
      notes:
        '1 km easy warmup, then 4 Ã— 400 m @ 4:50â€“5:05 with 90s rest, then 1 km tempo @ 5:20â€“5:40, then 1 km easy cooldown.'
    },
    '6x800_vo2': {
      name: '6Ã—800m VOâ‚‚',
      type: 'Intervals',
      totalDistance: 2 + 6 * 0.8 + 1, // 2 km WU, 6x800, 1 km CD
      pace: 'See parts',
      notes:
        '2 km easy warmup, then 6 Ã— 800 m @ 5K pace with 2 min jog/walk, then 1 km easy cooldown.'
    },
    'tempo20': {
      name: '20 min tempo',
      type: 'Tempo',
      totalDistance: 1 + 1 + 4, // approximate 20 min tempo as ~4 km
      pace: 'Tempo effort',
      notes:
        '1 km easy warmup, then 20 min tempo at comfortably hard pace (can say 1â€“2 words), then 1 km easy cooldown (~4 km total).'
    }
  };

  // Training plans: generator + which weekdays to use (priority order)
  // dow: 0=Mon ... 6=Sun
  const TRAINING_PLANS = {
    '5k-beginner': {
      name: '5K Beginner',
      daysOrder: [6, 2, 0, 4],
      generator: (week, totalWeeks, dow) => {
        const progress = totalWeeks > 1 ? week / (totalWeeks - 1) : 0;
        const longDist = 4 + Math.round(progress * 4);
        const easyDist = 3 + Math.round(progress * 2);

        if (dow === 0) return { type: 'Easy', dist: easyDist, pace: '6:20', notes: 'Easy conversational run.' };
        if (dow === 2) return { type: 'Tempo', dist: 3, pace: '5:40', notes: 'Short tempo in the middle.' };
        if (dow === 4) return { type: 'Easy', dist: easyDist, pace: '6:15', notes: 'Shakeout run.' };
        if (dow === 6) return { type: 'Long', dist: longDist, pace: '6:40', notes: 'Long slow run. Focus on time on feet.' };
        return { type: 'Rest', dist: 0 };
      }
    },
    '10k-build': {
      name: '10K Build',
      daysOrder: [6, 4, 2, 0],
      generator: (week, totalWeeks, dow) => {
        const progress = totalWeeks > 1 ? week / (totalWeeks - 1) : 0;
        const longDist = 6 + Math.round(progress * 8);
        const midLong = 5 + Math.round(progress * 4);

        if (dow === 0) return { type: 'Easy', dist: 5, pace: '6:15', notes: 'Relaxed easy run.' };
        if (dow === 2) return { type: 'Intervals', dist: 6, pace: '5:20', notes: 'Intervals or fartlek session.' };
        if (dow === 4) return { type: 'Tempo', dist: midLong, pace: '5:35', notes: 'Controlled tempo effort.' };
        if (dow === 6) return { type: 'Long', dist: longDist, pace: '6:30', notes: 'Key endurance run.' };
        return { type: 'Rest', dist: 0 };
      }
    },
    'hm-12w': {
      name: 'Half Marathon',
      daysOrder: [6, 4, 2, 0, 3],
      generator: (week, totalWeeks, dow) => {
        const progress = totalWeeks > 1 ? week / (totalWeeks - 1) : 0;
        const longDist = 8 + Math.round(progress * 13);
        const easyDist = 6 + Math.round(progress * 3);
        const midLong = 10 + Math.round(progress * 5);

        if (dow === 0) return { type: 'Easy', dist: easyDist, pace: '6:10', notes: 'Recovery from long run.' };
        if (dow === 2) return { type: 'Intervals', dist: 8, pace: '5:20', notes: 'Interval or VO2 session.' };
        if (dow === 3) return { type: 'Easy', dist: 6, pace: '6:15', notes: 'Easy run, low effort.' };
        if (dow === 4) return { type: 'Tempo', dist: midLong, pace: '5:35', notes: 'Tempo around threshold.' };
        if (dow === 6) return { type: 'Long', dist: longDist, pace: '6:30', notes: 'Key long run of the week.' };
        return { type: 'Rest', dist: 0 };
      }
    },
    'marathon': {
      name: 'Marathon',
      daysOrder: [6, 4, 2, 0, 3],
      generator: (week, totalWeeks, dow) => {
        const progress = totalWeeks > 1 ? week / (totalWeeks - 1) : 0;
        const longDist = 14 + Math.round(progress * 18);
        const easyDist = 8 + Math.round(progress * 4);
        const midLong = 12 + Math.round(progress * 6);

        if (dow === 0) return { type: 'Easy', dist: easyDist, pace: '6:15', notes: 'Easy recovery from long run.' };
        if (dow === 2) return { type: 'Intervals', dist: 10, pace: '5:15', notes: 'Speed / VO2 session.' };
        if (dow === 3) return { type: 'Easy', dist: 8, pace: '6:10', notes: 'Comfortable easy run.' };
        if (dow === 4) return { type: 'Tempo', dist: midLong, pace: '5:35', notes: 'Marathon-pace or tempo block.' };
        if (dow === 6) return { type: 'Long', dist: longDist, pace: '6:30', notes: 'Main marathon long run.' };
        return { type: 'Rest', dist: 0 };
      }
    }
  };

  const calendarEl = document.getElementById('calendar');
  const monthLabel = document.getElementById('monthLabel');
  const prevMonthBtn = document.getElementById('prevMonthBtn');
  const nextMonthBtn = document.getElementById('nextMonthBtn');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalDateEl = document.getElementById('modalDate');
  const runTypeEl = document.getElementById('runType');
  const workoutTemplateEl = document.getElementById('workoutTemplate');
  const templateHintEl = document.getElementById('templateHint');
  const plannedDistanceEl = document.getElementById('plannedDistance');
  const plannedPaceEl = document.getElementById('plannedPace');
  const actualDistanceEl = document.getElementById('actualDistance');
  const actualPaceEl = document.getElementById('actualPace');
  const rpeEl = document.getElementById('rpe');
  const shoeEl = document.getElementById('shoe');
  const shoeOptionsEl = document.getElementById('shoeOptions');
  const sleepEl = document.getElementById('sleep');
  const fatigueEl = document.getElementById('fatigue');
  const notesEl = document.getElementById('notes');
  const saveBtn = document.getElementById('saveBtn');
  const closeBtn = document.getElementById('closeBtn');
  const deleteBtn = document.getElementById('deleteBtn');

  const statsPlannedKm = document.getElementById('statsPlannedKm');
  const statsDoneKm = document.getElementById('statsDoneKm');
  const statsRuns = document.getElementById('statsRuns');

  const streakCurrentEl = document.getElementById('streakCurrent');
  const streakBestEl = document.getElementById('streakBest');

  const sleepFatigueSummaryEl = document.getElementById('sleepFatigueSummary');
  const shoeSummaryEl = document.getElementById('shoeSummary');

  const themeToggleBtn = document.getElementById('themeToggleBtn');

  const loginEmailEl = document.getElementById('loginEmail');
  const loginPasswordEl = document.getElementById('loginPassword');
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authStatus = document.getElementById('authStatus');
  const shareCodeEl = document.getElementById('shareCode');
  const syncStatus = document.getElementById('syncStatus');

  const pdfBtn = document.getElementById('pdfBtn');
  const coachAdviceEl = document.getElementById('coachAdvice');

  const weekDistanceCanvas = document.getElementById('weekDistanceCanvas');
  const weekPaceCanvas = document.getElementById('weekPaceCanvas');
  const rpePaceCanvas = document.getElementById('rpePaceCanvas');

  const planSelect = document.getElementById('planSelect');
  const planStartDateInput = document.getElementById('planStartDate');
  const planRaceDateInput = document.getElementById('planRaceDate');
  const planDaysPerWeekSelect = document.getElementById('planDaysPerWeek');
  const applyPlanBtn = document.getElementById('applyPlanBtn');
  const clearPlanBtn = document.getElementById('clearPlanBtn');
  const forceClearPlanBtn = document.getElementById('forceClearPlanBtn');
  const colorThemeSelect = document.getElementById('colorThemeSelect');

  const friendCodeInput = document.getElementById('friendCodeInput');
  const viewFriendBtn = document.getElementById('viewFriendBtn');
  const backToMeBtn = document.getElementById('backToMeBtn');

  const coachLangSelect = document.getElementById('coachLangSelect');
  const todayFab = document.getElementById('todayFab');

  let weekDistanceChart = null;
  let weekPaceChart = null;
  let rpePaceChart = null;

  let currentMonth = new Date();
  currentMonth.setDate(1);
  let selectedDateKey = null;
  let currentUser = null;

  // friend view state
  let friendMode = false;
  let friendId = null;
  let friendRunsCache = {};

  let coachLang = localStorage.getItem('runCalendarCoachLang') || 'en';
  coachLangSelect.value = coachLang;

  // THEME: dark/light
  function applyTheme(theme) {
    document.body.setAttribute('data-theme', theme);
    localStorage.setItem('runCalendarTheme', theme);
    if (theme === 'dark') {
      themeToggleBtn.textContent = 'ðŸŒž';
      themeToggleBtn.setAttribute('data-label', 'Light');
    } else {
      themeToggleBtn.textContent = 'ðŸŒ™';
      themeToggleBtn.setAttribute('data-label', 'Dark');
    }
  }

  const savedTheme = localStorage.getItem('runCalendarTheme');
  if (savedTheme) {
    applyTheme(savedTheme);
  } else {
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    applyTheme(prefersDark ? 'dark' : 'light');
  }

  themeToggleBtn.addEventListener('click', () => {
    const current = document.body.getAttribute('data-theme') || 'dark';
    applyTheme(current === 'dark' ? 'light' : 'dark');
  });

  // COLOR THEME
  function applyColorTheme(name) {
    const theme = COLOR_THEMES[name] || COLOR_THEMES.default;
    Object.entries(theme).forEach(([varName, value]) => {
      document.documentElement.style.setProperty(varName, value);
    });
    localStorage.setItem('runCalendarColorTheme', name);
  }

  const savedColorTheme = localStorage.getItem('runCalendarColorTheme') || 'default';
  colorThemeSelect.value = savedColorTheme;
  applyColorTheme(savedColorTheme);

  colorThemeSelect.addEventListener('change', () => {
    const val = colorThemeSelect.value;
    applyColorTheme(val);
  });

  // STORAGE
  function getStorage() {
    if (friendMode) {
      return friendRunsCache || {};
    }
    if (!currentUser) return {};
    const key = 'runCalendarData_' + currentUser.id;
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : {};
  }

  function setStorage(data) {
    if (friendMode) {
      friendRunsCache = data;
      return;
    }
    if (!currentUser) return;
    const key = 'runCalendarData_' + currentUser.id;
    localStorage.setItem(key, JSON.stringify(data));
  }

  function formatDateKey(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  // CALENDAR
  function renderCalendar() {
    calendarEl.innerHTML = '';

    const weekDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    weekDays.forEach(d => {
      const div = document.createElement('div');
      div.textContent = d;
      div.className = 'weekday';
      calendarEl.appendChild(div);
    });

    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const firstDayOfWeek = (new Date(year, month, 1).getDay() + 6) % 7;
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const runs = getStorage();
    const todayKey = formatDateKey(new Date());

    monthLabel.textContent = currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' });

    for (let i = 0; i < firstDayOfWeek; i++) {
      const empty = document.createElement('div');
      calendarEl.appendChild(empty);
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const cell = document.createElement('div');
      cell.className = 'day';
      const dateObj = new Date(year, month, day);
      const key = formatDateKey(dateObj);

      if (key === todayKey) {
        cell.classList.add('today');
      }

      const num = document.createElement('div');
      num.className = 'day-number';
      num.textContent = day;
      cell.appendChild(num);

      const run = runs[key];
      if (run) {
        const tag = document.createElement('div');
        tag.className = 'run-tag type-' + (run.type || 'Rest');
        tag.textContent = run.type || 'Rest';
        cell.appendChild(tag);

        const dist = document.createElement('div');
        dist.className = 'day-distance';

        if (run.actualDistance) {
          dist.innerHTML = `<span class="done">${run.actualDistance.toFixed(1)} km</span>` +
            (run.plannedDistance ? ` / ${run.plannedDistance.toFixed(1)} km` : '');
        } else if (run.plannedDistance) {
          dist.textContent = `${run.plannedDistance.toFixed(1)} km planned`;
        } else {
          dist.textContent = 'No distance set';
        }
        cell.appendChild(dist);

        if (run.actualDistance) {
          const dot = document.createElement('div');
          dot.className = 'completed-dot';
          cell.appendChild(dot);
        }
      }

      cell.addEventListener('click', () => {
        if (friendMode) {
          alert("You are viewing a friend's calendar (read-only).");
          return;
        }
        openModal(key);
      });
      calendarEl.appendChild(cell);
    }

    updateAnalytics(runs);
  }

  function openModal(dateKey) {
    selectedDateKey = dateKey;
    const runs = getStorage();
    const run = runs[dateKey] || { type: 'Rest' };

    const [y, m, d] = dateKey.split('-');
    modalDateEl.textContent = `${d}/${m}/${y}`;

    runTypeEl.value = run.type || 'Rest';
    workoutTemplateEl.value = '';
    templateHintEl.textContent = '';

    plannedDistanceEl.value = run.plannedDistance ?? '';
    plannedPaceEl.value = run.plannedPace ?? '';
    actualDistanceEl.value = run.actualDistance ?? '';
    actualPaceEl.value = run.actualPace ?? '';
    rpeEl.value = run.rpe ?? '';
    shoeEl.value = run.shoe ?? '';
    sleepEl.value = run.sleep ?? '';
    fatigueEl.value = run.fatigue ?? '';
    notesEl.value = run.notes ?? '';

    modalBackdrop.classList.add('show');
  }

  function closeModal() {
    modalBackdrop.classList.remove('show');
    selectedDateKey = null;
  }

  // Workout template application
  workoutTemplateEl.addEventListener('change', () => {
    const tplId = workoutTemplateEl.value;
    const tpl = WORKOUT_TEMPLATES[tplId];
    if (!tpl) {
      templateHintEl.textContent = '';
      return;
    }
    templateHintEl.textContent = tpl.name + ' â€“ auto-filled into this run.';

    if (!runTypeEl.value || runTypeEl.value === 'Rest') {
      runTypeEl.value = tpl.type;
    }
    if (!plannedDistanceEl.value && tpl.totalDistance) {
      plannedDistanceEl.value = tpl.totalDistance.toFixed(1);
    }
    if (!plannedPaceEl.value && tpl.pace) {
      plannedPaceEl.value = tpl.pace;
    }
    if (!notesEl.value) {
      notesEl.value = tpl.notes;
    } else {
      notesEl.value += (notesEl.value.endsWith('\n') ? '' : '\n') + tpl.notes;
    }
  });

  // SAVE / DELETE
  saveBtn.addEventListener('click', async () => {
    if (friendMode) {
      alert('Friend view is read-only. Switch back to your calendar to edit runs.');
      return;
    }
    if (!selectedDateKey) return;

    const dateKey = selectedDateKey;

    const runs = getStorage();
    const existing = runs[dateKey];

    const runObj = {
      type: runTypeEl.value,
      plannedDistance: plannedDistanceEl.value ? parseFloat(plannedDistanceEl.value) : null,
      plannedPace: plannedPaceEl.value || null,
      actualDistance: actualDistanceEl.value ? parseFloat(actualDistanceEl.value) : null,
      actualPace: actualPaceEl.value || null,
      rpe: rpeEl.value ? parseInt(rpeEl.value, 10) : null,
      shoe: shoeEl.value || null,
      sleep: sleepEl.value ? parseInt(sleepEl.value, 10) : null,
      fatigue: fatigueEl.value ? parseInt(fatigueEl.value, 10) : null,
      notes: notesEl.value || '',
      planId: existing ? existing.planId || null : null
    };

    runs[dateKey] = runObj;
    setStorage(runs);
    renderCalendar();
    closeModal();

    if (currentUser) {
      await saveRunToSupabase(currentUser.id, dateKey, runObj);
    }
  });

  deleteBtn.addEventListener('click', async () => {
    if (friendMode) {
      alert('Friend view is read-only. Switch back to your calendar to edit runs.');
      return;
    }
    if (!selectedDateKey) return;
    const dateKey = selectedDateKey;
    const runs = getStorage();
    delete runs[dateKey];
    setStorage(runs);
    renderCalendar();
    closeModal();

    if (currentUser) {
      await deleteRunFromSupabase(currentUser.id, dateKey);
    }
  });

  closeBtn.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e) => {
    if (e.target === modalBackdrop) closeModal();
  });

  prevMonthBtn.addEventListener('click', () => {
    currentMonth.setMonth(currentMonth.getMonth() - 1);
    renderCalendar();
  });

  nextMonthBtn.addEventListener('click', () => {
    currentMonth.setMonth(currentMonth.getMonth() + 1);
    renderCalendar();
  });

  // Today FAB
  todayFab.addEventListener('click', () => {
    const today = new Date();
    currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    renderCalendar();
    const todayKey = formatDateKey(today);
    if (!friendMode) openModal(todayKey);
  });

  // WEEK STATS
  function updateThisWeekStats(runs) {
    const now = new Date();
    const dayOfWeek = (now.getDay() + 6) % 7;
    const monday = new Date(now);
    monday.setDate(now.getDate() - dayOfWeek);

    let plannedKm = 0;
    let doneKm = 0;
    let runCount = 0;

    for (let i = 0; i < 7; i++) {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      const key = formatDateKey(d);
      const run = runs[key];
      if (!run) continue;

      if (run.plannedDistance) plannedKm += run.plannedDistance;
      if (run.actualDistance) {
        doneKm += run.actualDistance;
        runCount += 1;
      }
    }

    statsPlannedKm.textContent = plannedKm.toFixed(1);
    statsDoneKm.textContent = doneKm.toFixed(1);
    statsRuns.textContent = runCount;
  }

  // STREAKS
  function updateStreaks(runs) {
    const today = new Date();
    let currentStreak = 0;
    let bestStreak = 0;

    let streak = 0;
    const temp = new Date(today);
    for (let i = 0; i < 365; i++) {
      const key = formatDateKey(temp);
      const run = runs[key];
      const hasRun = run && run.actualDistance && run.actualDistance > 0;
      if (hasRun) {
        streak++;
        bestStreak = Math.max(bestStreak, streak);
      } else {
        streak = 0;
      }
      temp.setDate(temp.getDate() - 1);
    }

    const temp2 = new Date(today);
    while (true) {
      const key = formatDateKey(temp2);
      const run = runs[key];
      const hasRun = run && run.actualDistance && run.actualDistance > 0;
      if (hasRun) {
        currentStreak++;
        temp2.setDate(temp2.getDate() - 1);
      } else {
        break;
      }
    }

    streakCurrentEl.textContent = `${currentStreak} day${currentStreak === 1 ? '' : 's'}`;
    streakBestEl.textContent = `${bestStreak} day${bestStreak === 1 ? '' : 's'}`;
  }

  // Pace helpers
  function paceStringToSeconds(str) {
    if (!str) return null;
    const cleaned = String(str).split('â€“')[0].split('-')[0].trim();
    const parts = cleaned.split(':');
    if (parts.length < 2) return null;
    const min = parseInt(parts[0], 10);
    const sec = parseInt(parts[1], 10);
    if (isNaN(min) || isNaN(sec)) return null;
    return min * 60 + sec;
  }

  function secondsToPace(sec) {
    if (!sec || !isFinite(sec)) return null;
    const m = Math.floor(sec / 60);
    const s = Math.round(sec % 60);
    return `${m}:${String(s).padStart(2,'0')}`;
  }

  function updateCharts(runs) {
    const now = new Date();
    const weekMap = new Map();

    for (let offset = 0; offset < 6 * 7 + 7; offset++) {
      const d = new Date(now);
      d.setDate(now.getDate() - offset);
      const key = formatDateKey(d);
      const run = runs[key];
      if (!run || !run.actualDistance) continue;

      const dow = (d.getDay() + 6) % 7;
      const monday = new Date(d);
      monday.setDate(d.getDate() - dow);
      const mondayKey = formatDateKey(monday);

      if (!weekMap.has(mondayKey)) {
        weekMap.set(mondayKey, { dist: 0, paceSecSum: 0, distForPace: 0 });
      }
      const bucket = weekMap.get(mondayKey);
      bucket.dist += run.actualDistance;

      const paceSec = paceStringToSeconds(run.actualPace);
      if (paceSec) {
        bucket.paceSecSum += paceSec * run.actualDistance;
        bucket.distForPace += run.actualDistance;
      }
    }

    const weekKeys = Array.from(weekMap.keys()).sort();
    const labels = [];
    const distData = [];
    const paceData = [];

    weekKeys.forEach(k => {
      const monday = new Date(k);
      labels.push(`Week of ${monday.getDate()}/${monday.getMonth()+1}`);
      const b = weekMap.get(k);
      distData.push(b.dist.toFixed(1));
      if (b.distForPace > 0) {
        const avgSec = b.paceSecSum / b.distForPace;
        paceData.push(avgSec);
      } else {
        paceData.push(null);
      }
    });

    if (weekDistanceChart) weekDistanceChart.destroy();
    if (labels.length > 0) {
      weekDistanceChart = new Chart(weekDistanceCanvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Weekly distance (km)',
            data: distData
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    if (weekPaceChart) weekPaceChart.destroy();
    if (labels.length > 0) {
      weekPaceChart = new Chart(weekPaceCanvas.getContext('2d'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Average pace (min/km)',
            data: paceData,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const val = ctx.parsed.y;
                  return val ? `Avg pace: ${secondsToPace(val)} min/km` : '';
                }
              }
            }
          },
          scales: {
            y: {
              ticks: {
                callback: (v) => secondsToPace(v) || ''
              }
            }
          }
        }
      });
    }

    // RPE vs Pace scatter (last ~60 days)
    const points = [];
    const today = new Date();
    for (let i = 0; i < 60; i++) {
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      const key = formatDateKey(d);
      const run = runs[key];
      if (!run || !run.actualDistance || !run.actualPace || !run.rpe) continue;
      const paceSec = paceStringToSeconds(run.actualPace);
      if (!paceSec) continue;
      points.push({
        x: paceSec,
        y: run.rpe,
        label: `${d.getDate()}/${d.getMonth()+1}`
      });
    }

    if (rpePaceChart) rpePaceChart.destroy();
    if (points.length > 0) {
      rpePaceChart = new Chart(rpePaceCanvas.getContext('2d'), {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'RPE vs pace',
            data: points
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const raw = ctx.raw;
                  return `${raw.label}: ${secondsToPace(raw.x)} min/km, RPE ${raw.y}`;
                }
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Pace (min/km)' },
              ticks: {
                callback: (v) => secondsToPace(v) || ''
              }
            },
            y: {
              title: { display: true, text: 'RPE (1â€“10)' },
              min: 1,
              max: 10
            }
          }
        }
      });
    }
  }

  // Coach
  function updateCoach(runs) {
    const today = new Date();
    const last21 = [];
    for (let i = 0; i < 21; i++) {
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      const key = formatDateKey(d);
      const run = runs[key];
      if (!run || !run.actualDistance) continue;
      const paceSec = paceStringToSeconds(run.actualPace);
      last21.push({
        date: d,
        key,
        dist: run.actualDistance,
        rpe: run.rpe ?? null,
        sleep: run.sleep ?? null,
        fatigue: run.fatigue ?? null,
        paceSec
      });
    }

    if (last21.length === 0) {
      const en =
        "No runs logged yet. Start with 3â€“4 km at a pace where you can talk in full sentences. " +
        "Log how it felt (RPE 4â€“6) and I'll adjust your next runs.";
      const gr =
        "Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÎµÎ¹ Î±ÎºÏŒÎ¼Î± Ï€ÏÎ¿Ï€Î¿Î½Î®ÏƒÎµÎ¹Ï‚. ÎžÎµÎºÎ¯Î½Î± Î¼Îµ 3â€“4 km ÏƒÎµ ÏÏ…Î¸Î¼ÏŒ Ï€Î¿Ï… Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î¼Î¹Î»Î¬Ï‚ Î¬Î½ÎµÏ„Î±. " +
        "Î“ÏÎ¬ÏˆÎµ Ï€ÏŽÏ‚ ÏƒÎ¿Ï… Ï†Î¬Î½Î·ÎºÎµ (RPE 4â€“6) ÎºÎ±Î¹ Î¼ÎµÏ„Î¬ Î¸Î± Ï€ÏÎ¿ÏƒÎ±ÏÎ¼ÏŒÏƒÏ‰ Ï„Î¹Ï‚ ÎµÏ€ÏŒÎ¼ÎµÎ½ÎµÏ‚ Ï€ÏÎ¿Ï€Î¿Î½Î®ÏƒÎµÎ¹Ï‚ ÏƒÎ¿Ï….";

      coachAdviceEl.textContent = coachLang === 'gr'
        ? `Î ÏÎ¿Ï€Î¿Î½Î·Ï„Î®Ï‚: ${gr}`
        : `Coach: ${en}`;
      return;
    }

    const last7Date = new Date(today);
    last7Date.setDate(today.getDate() - 6);
    const prev14Date = new Date(today);
    prev14Date.setDate(today.getDate() - 13);

    let last7Dist = 0, prev7Dist = 0;
    let recentPaces = [];

    last21.forEach(r => {
      if (r.paceSec) recentPaces.push(r.paceSec);
      if (r.date >= last7Date) last7Dist += r.dist;
      else if (r.date >= prev14Date) prev7Dist += r.dist;
    });

    recentPaces.sort((a,b) => a-b);
    const medianPace = recentPaces.length
      ? recentPaces[Math.floor(recentPaces.length / 2)]
      : 6 * 60;
    const easyPaceSec = medianPace + 20;

    // Last 2 days RPE
    let last2Dist = 0;
    let last2Rpe = [];
    for (let i = 0; i < 2; i++) {
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      const key = formatDateKey(d);
      const run = runs[key];
      if (run && run.actualDistance) {
        last2Dist += run.actualDistance;
        if (run.rpe) last2Rpe.push(run.rpe);
      }
    }
    const avgLast2Rpe = last2Rpe.length
      ? last2Rpe.reduce((a,b)=>a+b,0)/last2Rpe.length
      : null;

    // Last 3 days sleep & fatigue
    let sleepVals = [];
    let fatigueVals = [];
    for (let i = 0; i < 3; i++) {
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      const key = formatDateKey(d);
      const run = runs[key];
      if (run) {
        if (run.sleep) sleepVals.push(run.sleep);
        if (run.fatigue) fatigueVals.push(run.fatigue);
      }
    }
    const avgSleep3 = sleepVals.length ? sleepVals.reduce((a,b)=>a+b,0)/sleepVals.length : null;
    const avgFatigue3 = fatigueVals.length ? fatigueVals.reduce((a,b)=>a+b,0)/fatigueVals.length : null;

    const easyPaceStr = secondsToPace(easyPaceSec) || "comfortable";

    let enMsg = "";
    let grMsg = "";

    if (last7Dist > 0 && prev7Dist > 0 && last7Dist > prev7Dist * 1.3) {
      enMsg += `You've increased your weekly distance quite a bit (${last7Dist.toFixed(1)} km vs ${prev7Dist.toFixed(1)} km). `;
      enMsg += "Try not to ramp up more than ~10â€“20% per week. ";

      grMsg += `ÎˆÏ‡ÎµÎ¹Ï‚ Î±Ï…Î¾Î®ÏƒÎµÎ¹ Î±ÏÎºÎµÏ„Î¬ Ï„Î¿ ÎµÎ²Î´Î¿Î¼Î±Î´Î¹Î±Î¯Î¿ ÏƒÎ¿Ï… Ï†Î¿ÏÏ„Î¯Î¿ (${last7Dist.toFixed(1)} km ÏƒÎµ ÏƒÏ‡Î­ÏƒÎ· Î¼Îµ ${prev7Dist.toFixed(1)} km). `;
      grMsg += "Î ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î½Î± Î¼Î·Î½ Î±Î½ÎµÎ²Î¬Î¶ÎµÎ¹Ï‚ Ï„Î± Ï‡Î¹Î»Î¹ÏŒÎ¼ÎµÏ„ÏÎ± Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ ~10â€“20% Ï„Î·Î½ ÎµÎ²Î´Î¿Î¼Î¬Î´Î±. ";
    }

    if (avgSleep3 !== null && avgSleep3 <= 4) {
      enMsg += "Sleep has been on the low side lately. Prioritize an easier day or an extra hour of sleep before pushing hard. ";
      grMsg += "ÎŸ ÏÏ€Î½Î¿Ï‚ ÏƒÎ¿Ï… ÎµÎ¯Î½Î±Î¹ Î»Î¯Î³Î¿ Ï‡Î±Î¼Î·Î»ÏŒÏ‚ Ï„Î¹Ï‚ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚ Î·Î¼Î­ÏÎµÏ‚. Î ÏÎ¿Ï„Î¯Î¼Î·ÏƒÎµ Î¼Î¹Î± Ï€Î¹Î¿ Ï‡Î±Î»Î±ÏÎ® Î¼Î­ÏÎ± Î® Î¼Î¯Î± ÏŽÏÎ± Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰ ÏÏ€Î½Î¿ Ï€ÏÎ¹Î½ Ï€Î¹Î­ÏƒÎµÎ¹Ï‚. ";
    }

    if (avgFatigue3 !== null && avgFatigue3 >= 7) {
      enMsg += "Your fatigue scores are high. A lighter day or full rest now can help you absorb the training better. ";
      grMsg += "Î— ÎºÎ¿ÏÏÎ±ÏƒÎ® ÏƒÎ¿Ï… ÎµÎ¯Î½Î±Î¹ Î±Ï…Î¾Î·Î¼Î­Î½Î·. ÎœÎ¹Î± Ï€Î¹Î¿ ÎµÎ»Î±Ï†ÏÎ¹Î¬ Î¼Î­ÏÎ± Î® Ï€Î»Î®ÏÎ·Ï‚ Î¾ÎµÎºÎ¿ÏÏÎ±ÏƒÎ· Ï„ÏŽÏÎ± Î¸Î± ÏƒÎµ Î²Î¿Î·Î¸Î®ÏƒÎ¿Ï…Î½ Î½Î± Â«Ï‡Ï‰Î½Î­ÏˆÎµÎ¹Ï‚Â» Ï„Î·Î½ Ï€ÏÎ¿Ï€ÏŒÎ½Î·ÏƒÎ·. ";
    }

    if (last2Dist > 0 && avgLast2Rpe && avgLast2Rpe >= 7) {
      enMsg += "The last couple of runs were tough. Tomorrow is a good candidate for either a rest day or an easy 3â€“4 km recovery jog ";
      enMsg += `around ${easyPaceStr} min/km. `;

      grMsg += "ÎŸÎ¹ Î´ÏÎ¿ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚ Ï€ÏÎ¿Ï€Î¿Î½Î®ÏƒÎµÎ¹Ï‚ Î®Ï„Î±Î½ Î±ÏÎºÎµÏ„Î¬ Î´ÏÏƒÎºÎ¿Î»ÎµÏ‚. Î‘ÏÏÎ¹Î¿ ÎµÎ¯Î½Î±Î¹ ÎºÎ±Î»Î® Î¹Î´Î­Î± Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚ ÎµÎ¯Ï„Îµ Î¾ÎµÎºÎ¿ÏÏÎ±ÏƒÎ· ÎµÎ¯Ï„Îµ Î­Î½Î± Ï€Î¿Î»Ï Ï‡Î±Î»Î±ÏÏŒ 3â€“4 km recovery ";
      grMsg += `Î³ÏÏÏ‰ ÏƒÏ„Î± ${easyPaceStr} Î»ÎµÏ€Ï„Î¬/Ï‡Î»Î¼. `;
    } else {
      const targetDist = Math.min(Math.max(last7Dist / 3, 4), 10);

      enMsg += `For your next run, aim for about ${targetDist.toFixed(1)} km at an easy pace (~${easyPaceStr} min/km). `;
      enMsg += "Keep effort around RPE 5â€“6 so you finish feeling like you could do a bit more.";

      grMsg += `Î“Î¹Î± Ï„Î·Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î· Ï€ÏÎ¿Ï€ÏŒÎ½Î·ÏƒÎ® ÏƒÎ¿Ï…, ÏƒÏ„ÏŒÏ‡ÎµÏ…ÏƒÎµ Ï€ÎµÏÎ¯Ï€Î¿Ï… ÏƒÏ„Î± ${targetDist.toFixed(1)} km ÏƒÎµ Ï‡Î±Î»Î±ÏÏŒ ÏÏ…Î¸Î¼ÏŒ (~${easyPaceStr} Î»ÎµÏ€Ï„Î¬/Ï‡Î»Î¼). `;
      grMsg += "ÎšÏÎ¬Ï„Î± Ï„Î·Î½ Î­Î½Ï„Î±ÏƒÎ· Î³ÏÏÏ‰ ÏƒÏ„Î¿ RPE 5â€“6 ÏŽÏƒÏ„Îµ Î½Î± Ï„ÎµÎ»ÎµÎ¹ÏŽÏƒÎµÎ¹Ï‚ Î½Î¹ÏŽÎ¸Î¿Î½Ï„Î±Ï‚ ÏŒÏ„Î¹ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµÏ‚ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÎ¹Ï‚ Î»Î¯Î³Î¿ Î±ÎºÏŒÎ¼Î±.";
    }

    coachAdviceEl.textContent = coachLang === 'gr'
      ? `Î ÏÎ¿Ï€Î¿Î½Î·Ï„Î®Ï‚: ${grMsg}`
      : `Coach: ${enMsg}`;
  }

  function updateSleepFatigueSummary(runs) {
    const now = new Date();
    const start = new Date(now);
    start.setDate(now.getDate() - 6);

    let sleepVals = [];
    let fatigueVals = [];

    for (let i = 0; i < 7; i++) {
      const d = new Date(start);
      d.setDate(start.getDate() + i);
      const key = formatDateKey(d);
      const run = runs[key];
      if (!run) continue;
      if (run.sleep) sleepVals.push(run.sleep);
      if (run.fatigue) fatigueVals.push(run.fatigue);
    }

    if (!sleepVals.length && !fatigueVals.length) {
      sleepFatigueSummaryEl.textContent = '';
      return;
    }

    const avgSleep = sleepVals.length ? (sleepVals.reduce((a,b)=>a+b,0) / sleepVals.length) : null;
    const avgFatigue = fatigueVals.length ? (fatigueVals.reduce((a,b)=>a+b,0) / fatigueVals.length) : null;

    let text = 'Last 7 days ';
    if (avgSleep !== null) text += `Â· sleep avg ${avgSleep.toFixed(1)}/10 `;
    if (avgFatigue !== null) text += `Â· fatigue avg ${avgFatigue.toFixed(1)}/10`;

    sleepFatigueSummaryEl.textContent = text;
  }

  function updateShoeSummary(runs) {
    const shoeTotals = {};
    Object.keys(runs).forEach(key => {
      const r = runs[key];
      if (!r || !r.shoe || !r.actualDistance) return;
      const name = r.shoe.trim();
      if (!name) return;
      if (!shoeTotals[name]) shoeTotals[name] = 0;
      shoeTotals[name] += r.actualDistance;
    });

    // update datalist
    shoeOptionsEl.innerHTML = '';
    Object.keys(shoeTotals).forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      shoeOptionsEl.appendChild(opt);
    });

    if (Object.keys(shoeTotals).length === 0) {
      shoeSummaryEl.textContent = 'No shoes tracked yet. Add a shoe name to your runs to track total km.';
      return;
    }

    let html = 'Shoes km total:';
    html += '<ul>';
    Object.entries(shoeTotals).forEach(([name, km]) => {
      let label = `${name}: ${km.toFixed(1)} km`;
      if (km >= 800) label += ' âš  time to retire soon';
      else if (km >= 600) label += ' âš¡ getting high';
      html += `<li>${label}</li>`;
    });
    html += '</ul>';
    shoeSummaryEl.innerHTML = html;
  }

  function updateAnalytics(runs) {
    updateThisWeekStats(runs);
    updateStreaks(runs);
    updateCharts(runs);
    updateCoach(runs);
    updateSleepFatigueSummary(runs);
    updateShoeSummary(runs);
  }

  // Supabase sync
  async function loadFromSupabase(userId) {
    syncStatus.textContent = 'Loading...';
    try {
      const { data, error } = await supabase
        .from('runs')
        .select('date, data')
        .eq('sync_id', userId);

      if (error) {
        console.error('Supabase load error:', error);
        syncStatus.textContent = 'Error loading';
        alert('Supabase load error: ' + (error.message || JSON.stringify(error)));
        return;
      }

      const local = getStorage();
      data.forEach(row => {
        local[row.date] = row.data;
      });
      setStorage(local);

      renderCalendar();
      syncStatus.textContent = 'Loaded';
    } catch (e) {
      console.error('Unexpected load error:', e);
      syncStatus.textContent = 'Error';
      alert('Unexpected load error: ' + e.message);
    }
  }

  async function loadFriendFromSupabase(friendSyncId) {
    friendMode = true;
    friendId = friendSyncId;
    syncStatus.textContent = 'Loading friend...';
    try {
      const { data, error } = await supabase
        .from('runs')
        .select('date, data')
        .eq('sync_id', friendSyncId);

      if (error) {
        console.error('Supabase friend load error:', error);
        syncStatus.textContent = 'Error loading friend';
        alert('Could not load friend data: ' + (error.message || JSON.stringify(error)));
        return;
      }

      friendRunsCache = {};
      data.forEach(row => {
        friendRunsCache[row.date] = row.data;
      });

      if (shareCodeEl) {
        shareCodeEl.textContent = '';
      }
      authStatus.textContent = "Viewing friend calendar (read-only)";
      renderCalendar();
      syncStatus.textContent = 'Friend loaded';
    } catch (e) {
      console.error('Unexpected friend load error:', e);
      syncStatus.textContent = 'Error';
      alert('Unexpected friend load error: ' + e.message);
    }
  }

  async function saveRunToSupabase(userId, dateKey, runObj) {
    syncStatus.textContent = 'Syncing...';
    try {
      const { error } = await supabase
        .from('runs')
        .upsert(
          { sync_id: userId, date: dateKey, data: runObj },
          { onConflict: 'sync_id,date' }
        );
      if (error) {
        console.error(error);
        syncStatus.textContent = 'Sync error';
      } else {
        syncStatus.textContent = 'Synced';
      }
    } catch (e) {
      console.error(e);
      syncStatus.textContent = 'Sync error';
    }
  }

  async function deleteRunFromSupabase(userId, dateKey) {
    syncStatus.textContent = 'Syncing...';
    try {
      const { error } = await supabase
        .from('runs')
        .delete()
        .eq('sync_id', userId)
        .eq('date', dateKey);
      if (error) {
        console.error(error);
        syncStatus.textContent = 'Sync error';
      } else {
        syncStatus.textContent = 'Synced';
      }
    } catch (e) {
      console.error(e);
      syncStatus.textContent = 'Sync error';
    }
  }

  function updateAuthUI() {
    if (currentUser) {
      authStatus.textContent = `Logged in as ${currentUser.email}`;
      if (shareCodeEl) {
        shareCodeEl.textContent = `Share code: ${currentUser.id}`;
      }
      logoutBtn.style.display = 'inline-block';
    } else {
      authStatus.textContent = 'Not logged in';
      if (shareCodeEl) {
        shareCodeEl.textContent = '';
      }
      logoutBtn.style.display = 'none';
    }
  }

  // Auth
  loginBtn.addEventListener('click', async () => {
    const email = loginEmailEl.value.trim();
    const password = loginPasswordEl.value;
    if (!email || !password) {
      alert('Enter email and password.');
      return;
    }

    authStatus.textContent = 'Logging in...';
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      console.error(error);
      authStatus.textContent = 'Login error';
      alert(error.message);
      return;
    }
    if (data && data.session && data.session.user) {
      currentUser = data.session.user;
      updateAuthUI();
      await loadFromSupabase(currentUser.id);
    }
  });

  signupBtn.addEventListener('click', async () => {
    const email = loginEmailEl.value.trim();
    const password = loginPasswordEl.value;
    if (!email || !password) {
      alert('Enter email and password to sign up.');
      return;
    }

    authStatus.textContent = 'Creating account...';
    const { data, error } = await supabase.auth.signUp({ email, password });
    if (error) {
      console.error(error);
      authStatus.textContent = 'Sign up error';
      alert(error.message);
      return;
    }

    alert('Account created. If email confirmation is required, confirm it, then log in.');
    authStatus.textContent = 'Account created. Log in.';
  });

  logoutBtn.addEventListener('click', async () => {
    await supabase.auth.signOut();
    currentUser = null;
    friendMode = false;
    friendId = null;
    friendRunsCache = {};
    updateAuthUI();
    syncStatus.textContent = '';
    renderCalendar();
  });

  // Friend view buttons
  viewFriendBtn.addEventListener('click', async () => {
    const code = friendCodeInput.value.trim();
    if (!code) {
      alert('Paste a friend code first (they can find it under "Share code" when logged in).');
      return;
    }
    await loadFriendFromSupabase(code);
  });

  backToMeBtn.addEventListener('click', async () => {
    friendMode = false;
    friendId = null;
    friendRunsCache = {};
    if (currentUser) {
      updateAuthUI();
      await loadFromSupabase(currentUser.id);
    } else {
      updateAuthUI();
      renderCalendar();
    }
  });

  // PDF export
  pdfBtn.addEventListener('click', () => {
    if (!currentUser) {
      alert('Log in to export your runs.');
      return;
    }
    if (!jsPDF) {
      alert('PDF library not loaded.');
      return;
    }

    const doc = new jsPDF();
    const runs = getStorage();
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();

    const monthName = currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' });

    doc.setFontSize(16);
    doc.text('RunCalendar - Monthly Report', 10, 12);
    doc.setFontSize(11);
    doc.text(`Month: ${monthName}`, 10, 20);
    doc.text(`User: ${currentUser.email}`, 10, 26);

    let totalPlanned = 0;
    let totalDone = 0;
    let runCount = 0;

    const entries = [];

    Object.keys(runs).forEach(key => {
      const d = new Date(key);
      if (d.getFullYear() === year && d.getMonth() === month) {
        const r = runs[key];
        if (r.plannedDistance) totalPlanned += r.plannedDistance;
        if (r.actualDistance) {
          totalDone += r.actualDistance;
          runCount++;
        }
        entries.push({ key, date: d, run: r });
      }
    });

    entries.sort((a,b)=>a.date - b.date);

    doc.text(`Total planned: ${totalPlanned.toFixed(1)} km`, 10, 34);
    doc.text(`Total done: ${totalDone.toFixed(1)} km`, 10, 40);
    doc.text(`Runs logged: ${runCount}`, 10, 46);

    let y = 56;
    doc.setFontSize(11);
    doc.text('Day  Type        Planned   Actual   Pace   RPE   Notes', 10, y);
    y += 6;
    doc.setFontSize(10);

    entries.forEach(e => {
      const d = e.date;
      const r = e.run;
      const day = String(d.getDate()).padStart(2,'0');
      const type = (r.type || 'Rest').padEnd(10,' ');
      const pl = r.plannedDistance ? r.plannedDistance.toFixed(1) : '-';
      const ac = r.actualDistance ? r.actualDistance.toFixed(1) : '-';
      const pace = r.actualPace || '-';
      const rpe = r.rpe != null ? String(r.rpe) : '-';
      const line = `${day}  ${type}  ${pl.padStart(6,' ')}  ${ac.padStart(6,' ')}  ${pace.padStart(5,' ')}  ${rpe.padStart(3,' ')}  ${(r.notes||'').slice(0,40)}`;

      if (y > 280) {
        doc.addPage();
        y = 20;
      }
      doc.text(line, 10, y);
      y += 5;
    });

    const fileName = `RunCalendar_${year}_${month+1}.pdf`;
    doc.save(fileName);
  });

  // TRAINING PLANS
  function applyTrainingPlan() {
    if (friendMode) {
      alert('You cannot apply a plan while viewing a friend. Switch back to your calendar.');
      return;
    }
    if (!currentUser) {
      alert('Log in to apply a training plan.');
      return;
    }
    const planId = planSelect.value;
    if (planId === 'none') {
      alert('Select a training plan first.');
      return;
    }
    const plan = TRAINING_PLANS[planId];
    if (!plan) {
      alert('Unknown plan.');
      return;
    }

    const start = planStartDateInput.value;
    const race = planRaceDateInput.value;
    if (!start || !race) {
      alert('Choose both start date and race date.');
      return;
    }

    const [ys, ms, ds] = start.split('-').map(Number);
    const [yr, mr, dr] = race.split('-').map(Number);
    if (!ys || !ms || !ds || !yr || !mr || !dr) {
      alert('Invalid dates.');
      return;
    }

    const startDate = new Date(ys, ms - 1, ds);
    const raceDate = new Date(yr, mr - 1, dr);

    if (raceDate < startDate) {
      alert('Race date must be after start date.');
      return;
    }

    const diffMs = raceDate - startDate;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24)) + 1;
    const totalWeeks = Math.max(1, Math.ceil(diffDays / 7));

    const daysPerWeek = parseInt(planDaysPerWeekSelect.value, 10) || 3;
    const activeDays = new Set( (plan.daysOrder || []).slice(0, daysPerWeek) );

    const runs = getStorage();

    for (let week = 0; week < totalWeeks; week++) {
      for (let dow = 0; dow < 7; dow++) {
        const dayDate = new Date(startDate);
        dayDate.setDate(startDate.getDate() + week * 7 + dow);
        if (dayDate > raceDate) continue;

        if (!activeDays.has(dow)) continue;

        const key = formatDateKey(dayDate);
        const { type, dist, pace, notes } = plan.generator(week, totalWeeks, dow);

        if (!runs[key]) {
          if (type === 'Rest' && (!dist || dist === 0)) {
            continue;
          }
          runs[key] = {
            type: type || 'Rest',
            plannedDistance: dist || null,
            plannedPace: pace || null,
            actualDistance: null,
            actualPace: null,
            rpe: null,
            shoe: null,
            sleep: null,
            fatigue: null,
            notes: notes || '',
            planId: planId
          };
        }
      }
    }

    setStorage(runs);
    renderCalendar();

    if (currentUser) {
      (async () => {
        syncStatus.textContent = 'Syncing plan...';
        const upserts = [];
        Object.keys(runs).forEach(dateKey => {
          const r = runs[dateKey];
          upserts.push({ sync_id: currentUser.id, date: dateKey, data: r });
        });
        try {
          const { error } = await supabase
            .from('runs')
            .upsert(upserts, { onConflict: 'sync_id,date' });
          if (error) {
            console.error(error);
            syncStatus.textContent = 'Sync error';
          } else {
            syncStatus.textContent = 'Synced';
          }
        } catch (e) {
          console.error(e);
          syncStatus.textContent = 'Sync error';
        }
      })();
    }
  }

  applyPlanBtn.addEventListener('click', applyTrainingPlan);

  async function clearTrainingPlan() {
    if (friendMode) {
      alert('You cannot clear a plan while viewing a friend. Switch back to your calendar.');
      return;
    }
    if (!currentUser) {
      alert('Log in to clear a plan.');
      return;
    }

    const planId = planSelect.value;
    if (planId === 'none') {
      alert('Select the plan you want to clear from the dropdown.');
      return;
    }

    const runs = getStorage();
    const datesToDelete = [];

    Object.keys(runs).forEach(dateKey => {
      const r = runs[dateKey];
      if (r && r.planId === planId && (!r.actualDistance || r.actualDistance === 0)) {
        delete runs[dateKey];
        datesToDelete.push(dateKey);
      }
    });

    if (datesToDelete.length === 0) {
      setStorage(runs);
      renderCalendar();
      alert('No plan days found to clear (or all have logged runs).');
      return;
    }

    setStorage(runs);
    renderCalendar();

    if (currentUser && datesToDelete.length > 0) {
      syncStatus.textContent = 'Clearing plan...';
      try {
        const { error } = await supabase
          .from('runs')
          .delete()
          .eq('sync_id', currentUser.id)
          .in('date', datesToDelete);

        if (error) {
          console.error(error);
          syncStatus.textContent = 'Sync error';
          alert('Error clearing plan from server.');
        } else {
          syncStatus.textContent = 'Synced';
        }
      } catch (e) {
        console.error(e);
        syncStatus.textContent = 'Sync error';
        alert('Error clearing plan from server.');
      }
    }
  }

  clearPlanBtn.addEventListener('click', clearTrainingPlan);

  async function forceClearTrainingPlan() {
    if (friendMode) {
      alert('You cannot force clear while viewing a friend. Switch back to your calendar.');
      return;
    }
    if (!currentUser) {
      alert('Log in to force clear a plan.');
      return;
    }

    const planId = planSelect.value;
    if (planId === 'none') {
      alert('Select the plan you want to force clear from the dropdown.');
      return;
    }

    const confirmText =
      'âš  WARNING âš \n\n' +
      'This will delete ALL days created with this plan (including days where you have logged runs).\n' +
      'This cannot be undone.\n\n' +
      'Do you really want to continue?';

    if (!window.confirm(confirmText)) {
      return;
    }

    const runs = getStorage();
    const datesToDelete = [];

    Object.keys(runs).forEach(dateKey => {
      const r = runs[dateKey];
      if (r && r.planId === planId) {
        delete runs[dateKey];
        datesToDelete.push(dateKey);
      }
    });

    if (datesToDelete.length === 0) {
      setStorage(runs);
      renderCalendar();
      alert('No days found with this planId.');
      return;
    }

    setStorage(runs);
    renderCalendar();

    syncStatus.textContent = 'Force clearing plan...';
    try {
      const { error } = await supabase
        .from('runs')
        .delete()
        .eq('sync_id', currentUser.id)
        .in('date', datesToDelete);

      if (error) {
        console.error(error);
        syncStatus.textContent = 'Sync error';
        alert('Error force clearing plan from server.');
      } else {
        syncStatus.textContent = 'Synced';
      }
    } catch (e) {
      console.error(e);
      syncStatus.textContent = 'Sync error';
      alert('Error force clearing plan from server.');
    }
  }

  forceClearPlanBtn.addEventListener('click', forceClearTrainingPlan);

  // Coach language toggle
  coachLangSelect.addEventListener('change', () => {
    coachLang = coachLangSelect.value;
    localStorage.setItem('runCalendarCoachLang', coachLang);
    const runs = getStorage();
    updateCoach(runs);
  });

  // Session on load
  (async () => {
    const { data, error } = await supabase.auth.getSession();
    if (!error && data.session && data.session.user) {
      currentUser = data.session.user;
      updateAuthUI();
      await loadFromSupabase(currentUser.id);
    } else {
      renderCalendar();
    }
  })();
</script>
</body>
</html>

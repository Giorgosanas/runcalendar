<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RunCalendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Optional icon if you already have one -->
  <!-- <link rel="icon" type="image/png" href="icon-192.png" /> -->

  <style>
    :root {
      --bg: #f5f5f5;
      --card: #ffffff;
      --border: #e0e0e0;
      --primary: #2196f3;
      --danger: #f44336;
      --text: #222222;
      --text-muted: #666666;
      --radius: 12px;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
    }

    body[data-theme="dark"] {
      --bg: #101016;
      --card: #181823;
      --border: #262637;
      --primary: #4dabf7;
      --danger: #ff6b6b;
      --text: #f1f3f5;
      --text-muted: #adb5bd;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, rgba(33,150,243,0.18), transparent 55%), var(--bg);
      color: var(--text);
      transition: background 0.25s ease, color 0.25s ease;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.7rem 1rem 0.9rem;
      background: linear-gradient(135deg, #111827, #020617);
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    header h1 {
      font-size: 1rem;
      margin: 0;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      opacity: 0.95;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    header button {
      border: none;
      padding: 0.3rem 0.6rem;
      cursor: pointer;
      border-radius: 999px;
      font-size: 0.8rem;
      background: #1f2933;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
    }

    header button:hover {
      background: #374151;
    }

    #monthLabel {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .theme-toggle {
      font-size: 0.8rem;
      border-radius: 999px;
      padding: 0.3rem 0.7rem;
    }

    .auth-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      font-size: 0.8rem;
      margin-top: 0.1rem;
    }

    .auth-bar input {
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
    }

    .auth-bar button {
      border-radius: 999px;
      border: none;
      padding: 0.25rem 0.6rem;
      font-size: 0.8rem;
      cursor: pointer;
      background: var(--primary);
      color: #ffffff;
    }

    .auth-bar .secondary {
      background: #1f2937;
    }

    .sync-status {
      font-size: 0.75rem;
      opacity: 0.85;
    }

    main {
      padding: 0.8rem;
      max-width: 1000px;
      margin: 0 auto 1.2rem;
    }

    .calendar-card {
      background: rgba(255,255,255,0.9);
      border-radius: var(--radius);
      padding: 0.8rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    body[data-theme="dark"] .calendar-card {
      background: rgba(15,23,42,0.92);
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .weekday {
      font-weight: 600;
      text-align: center;
      padding: 0.3rem 0;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .day {
      background: var(--card);
      border-radius: 10px;
      padding: 0.3rem;
      min-height: 70px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      border: 1px solid var(--border);
      font-size: 0.75rem;
      position: relative;
      transition: transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease;
    }

    .day:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      border-color: var(--primary);
    }

    .day-number {
      font-weight: 600;
      margin-bottom: 0.2rem;
      font-size: 0.85rem;
    }

    .run-tag {
      padding: 0.12rem 0.4rem;
      border-radius: 999px;
      font-size: 0.7rem;
      display: inline-block;
      margin-bottom: 0.15rem;
      white-space: nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .type-Rest { background: #e0e0e0; color: #111827; }
    .type-Easy { background: #cfe8ff; color: #0f172a; }
    .type-Tempo { background: #ffe1b5; color: #4b1d03; }
    .type-Intervals { background: #ffc9c9; color: #3b0b0b; }
    .type-Long { background: #c8f7c5; color: #064e3b; }

    body[data-theme="dark"] .type-Rest { background: #4b5563; color: #f9fafb; }
    body[data-theme="dark"] .type-Easy { background: #1d4ed8; color: #e5e7eb; }
    body[data-theme="dark"] .type-Tempo { background: #f97316; color: #111827; }
    body[data-theme="dark"] .type-Intervals { background: #ef4444; color: #111827; }
    body[data-theme="dark"] .type-Long { background: #22c55e; color: #052e16; }

    .day-distance {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .day-distance span.done {
      font-weight: 600;
      color: var(--primary);
    }

    .today {
      border: 2px solid var(--primary);
    }

    .today::after {
      content: "Today";
      position: absolute;
      top: 4px;
      right: 6px;
      font-size: 0.6rem;
      color: var(--primary);
      opacity: 0.9;
    }

    .completed-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--primary);
      position: absolute;
      bottom: 4px;
      right: 6px;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 20;
    }

    .modal-backdrop.show { display: flex; }

    .modal {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1rem 1.1rem;
      width: 100%;
      max-width: 420px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .modal h2 {
      margin: 0 0 0.3rem;
      font-size: 1rem;
    }

    #modalDate {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.6rem;
    }

    .form-group {
      margin-bottom: 0.5rem;
      display: flex;
      flex-direction: column;
      font-size: 0.85rem;
    }

    .form-group label { margin-bottom: 0.15rem; }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.35rem 0.45rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
      background: var(--card);
      color: var(--text);
    }

    textarea { resize: vertical; }

    .form-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.7rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.4rem 0.7rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: #e0e0e0; color: #111827; }
    .btn-danger { background: var(--danger); color: white; }

    body[data-theme="dark"] .btn-secondary {
      background: #374151;
      color: #e5e7eb;
    }

    .stats {
      margin-top: 1rem;
      background: rgba(255,255,255,0.9);
      border-radius: var(--radius);
      padding: 0.7rem 0.9rem;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    body[data-theme="dark"] .stats {
      background: rgba(15,23,42,0.92);
    }

    .stats h3 {
      margin: 0 0 0.5rem;
      font-size: 0.9rem;
    }

    .stats-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.2rem;
    }

    .stats-row span.label {
      color: var(--text-muted);
    }

    @media (max-width: 700px) {
      main { padding: 0.6rem; }
      .calendar { gap: 2px; }
      .day { min-height: 60px; padding: 0.25rem; }
      .weekday { font-size: 0.7rem; }
      .auth-bar input {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body data-theme="light">
<header>
  <div class="header-top">
    <h1>RunCalendar</h1>
    <div class="header-controls">
      <button id="prevMonthBtn">&lt;</button>
      <div id="monthLabel"></div>
      <button id="nextMonthBtn">&gt;</button>
      <button id="themeToggleBtn" class="theme-toggle">ðŸŒ™ Dark</button>
    </div>
  </div>

  <div class="auth-bar">
    <input id="loginEmail" type="email" placeholder="Email" />
    <input id="loginPassword" type="password" placeholder="Password" />
    <button id="loginBtn" class="secondary">Log in</button>
    <button id="signupBtn">Sign up</button>
    <button id="logoutBtn" style="display:none;" class="secondary">Log out</button>
    <span id="authStatus" class="sync-status">Not logged in</span>
    <span id="syncStatus" class="sync-status"></span>
  </div>
</header>

<main>
  <div class="calendar-card">
    <div class="calendar" id="calendar"></div>
  </div>

  <div class="stats" id="statsBox">
    <h3>This Week</h3>
    <div class="stats-row">
      <span class="label">Planned km</span>
      <span id="statsPlannedKm">0</span>
    </div>
    <div class="stats-row">
      <span class="label">Done km</span>
      <span id="statsDoneKm">0</span>
    </div>
    <div class="stats-row">
      <span class="label">Runs logged</span>
      <span id="statsRuns">0</span>
    </div>
  </div>
</main>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <h2>Edit Run</h2>
    <p id="modalDate"></p>

    <div class="form-group">
      <label>Type</label>
      <select id="runType">
        <option value="Rest">Rest</option>
        <option value="Easy">Easy</option>
        <option value="Tempo">Tempo</option>
        <option value="Intervals">Intervals</option>
        <option value="Long">Long</option>
      </select>
    </div>
    <div class="form-group">
      <label>Planned distance (km)</label>
      <input type="number" step="0.1" id="plannedDistance" />
    </div>
    <div class="form-group">
      <label>Planned pace (min/km)</label>
      <input type="text" id="plannedPace" placeholder="e.g. 6:00" />
    </div>
    <div class="form-group">
      <label>Actual distance (km)</label>
      <input type="number" step="0.1" id="actualDistance" />
    </div>
    <div class="form-group">
      <label>Actual pace (min/km)</label>
      <input type="text" id="actualPace" placeholder="e.g. 5:50" />
    </div>
    <div class="form-group">
      <label>How it felt (1â€“10)</label>
      <input type="number" min="1" max="10" id="rpe" />
    </div>
    <div class="form-group">
      <label>Notes (route, weather, splitsâ€¦)</label>
      <textarea id="notes" rows="3"></textarea>
    </div>

    <div class="form-actions">
      <button class="btn btn-danger" id="deleteBtn">Clear</button>
      <div>
        <button class="btn btn-secondary" id="closeBtn">Cancel</button>
        <button class="btn btn-primary" id="saveBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ðŸ”§ PUT YOUR VALUES HERE
  const SUPABASE_URL = "https://bdhqktzwchswzwlmrpmd.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkaHFrdHp3Y2hzd3p3bG1ycG1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzY2NTUsImV4cCI6MjA4MDYxMjY1NX0.WAElPc6oei5haF1qqgqaEKmKrb82g4GYTQ6m-uVXdPk";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const calendarEl = document.getElementById('calendar');
  const monthLabel = document.getElementById('monthLabel');
  const prevMonthBtn = document.getElementById('prevMonthBtn');
  const nextMonthBtn = document.getElementById('nextMonthBtn');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalDateEl = document.getElementById('modalDate');
  const runTypeEl = document.getElementById('runType');
  const plannedDistanceEl = document.getElementById('plannedDistance');
  const plannedPaceEl = document.getElementById('plannedPace');
  const actualDistanceEl = document.getElementById('actualDistance');
  const actualPaceEl = document.getElementById('actualPace');
  const rpeEl = document.getElementById('rpe');
  const notesEl = document.getElementById('notes');
  const saveBtn = document.getElementById('saveBtn');
  const closeBtn = document.getElementById('closeBtn');
  const deleteBtn = document.getElementById('deleteBtn');

  const statsPlannedKm = document.getElementById('statsPlannedKm');
  const statsDoneKm = document.getElementById('statsDoneKm');
  const statsRuns = document.getElementById('statsRuns');

  const themeToggleBtn = document.getElementById('themeToggleBtn');

  const loginEmailEl = document.getElementById('loginEmail');
  const loginPasswordEl = document.getElementById('loginPassword');
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authStatus = document.getElementById('authStatus');
  const syncStatus = document.getElementById('syncStatus');

  let currentMonth = new Date();
  currentMonth.setDate(1);
  let selectedDateKey = null;
  let currentUser = null; // Supabase user object or null

  // THEME HANDLING
  function applyTheme(theme) {
    document.body.setAttribute('data-theme', theme);
    localStorage.setItem('runCalendarTheme', theme);
    themeToggleBtn.textContent = theme === 'dark' ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
  }

  const savedTheme = localStorage.getItem('runCalendarTheme');
  if (savedTheme) {
    applyTheme(savedTheme);
  } else {
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    applyTheme(prefersDark ? 'dark' : 'light');
  }

  themeToggleBtn.addEventListener('click', () => {
    const current = document.body.getAttribute('data-theme') || 'light';
    applyTheme(current === 'light' ? 'dark' : 'light');
  });

  // Local storage for runs (per user only; nothing saved when logged out)
  function getStorage() {
    if (!currentUser) {
      return {}; // logged out: always empty calendar
    }
    const key = 'runCalendarData_' + currentUser.id;
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : {};
  }

  function setStorage(data) {
    if (!currentUser) {
      // logged out: do not persist anything
      return;
    }
    const key = 'runCalendarData_' + currentUser.id;
    localStorage.setItem(key, JSON.stringify(data));
  }

  function formatDateKey(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  function renderCalendar() {
    calendarEl.innerHTML = '';

    const weekDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    weekDays.forEach(d => {
      const div = document.createElement('div');
      div.textContent = d;
      div.className = 'weekday';
      calendarEl.appendChild(div);
    });

    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const firstDayOfWeek = (new Date(year, month, 1).getDay() + 6) % 7; // Mon=0
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const runs = getStorage();
    const todayKey = formatDateKey(new Date());

    monthLabel.textContent = currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' });

    for (let i = 0; i < firstDayOfWeek; i++) {
      const empty = document.createElement('div');
      calendarEl.appendChild(empty);
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const cell = document.createElement('div');
      cell.className = 'day';
      const dateObj = new Date(year, month, day);
      const key = formatDateKey(dateObj);

      if (key === todayKey) {
        cell.classList.add('today');
      }

      const num = document.createElement('div');
      num.className = 'day-number';
      num.textContent = day;
      cell.appendChild(num);

      const run = runs[key];
      if (run) {
        const tag = document.createElement('div');
        tag.className = 'run-tag type-' + (run.type || 'Rest');
        tag.textContent = run.type || 'Rest';
        cell.appendChild(tag);

        const dist = document.createElement('div');
        dist.className = 'day-distance';

        if (run.actualDistance) {
          dist.innerHTML = `<span class="done">${run.actualDistance.toFixed(1)} km</span>` +
            (run.plannedDistance ? ` / ${run.plannedDistance.toFixed(1)} km` : '');
        } else if (run.plannedDistance) {
          dist.textContent = `${run.plannedDistance.toFixed(1)} km planned`;
        } else {
          dist.textContent = 'No distance set';
        }
        cell.appendChild(dist);

        if (run.actualDistance) {
          const dot = document.createElement('div');
          dot.className = 'completed-dot';
          cell.appendChild(dot);
        }
      }

      // You can still open the modal when logged out, but saving won't persist
      cell.addEventListener('click', () => openModal(key));
      calendarEl.appendChild(cell);
    }

    updateThisWeekStats(runs);
  }

  function openModal(dateKey) {
    selectedDateKey = dateKey;
    const runs = getStorage();
    const run = runs[dateKey] || { type: 'Rest' };

    const [y, m, d] = dateKey.split('-');
    modalDateEl.textContent = `${d}/${m}/${y}`;

    runTypeEl.value = run.type || 'Rest';
    plannedDistanceEl.value = run.plannedDistance ?? '';
    plannedPaceEl.value = run.plannedPace ?? '';
    actualDistanceEl.value = run.actualDistance ?? '';
    actualPaceEl.value = run.actualPace ?? '';
    rpeEl.value = run.rpe ?? '';
    notesEl.value = run.notes ?? '';

    modalBackdrop.classList.add('show');
  }

  function closeModal() {
    modalBackdrop.classList.remove('show');
    selectedDateKey = null;
  }

  saveBtn.addEventListener('click', async () => {
  if (!selectedDateKey) return;

  // keep a copy BEFORE we clear it
  const dateKey = selectedDateKey;

  const runs = getStorage();
  const runObj = {
    type: runTypeEl.value,
    plannedDistance: plannedDistanceEl.value ? parseFloat(plannedDistanceEl.value) : null,
    plannedPace: plannedPaceEl.value || null,
    actualDistance: actualDistanceEl.value ? parseFloat(actualDistanceEl.value) : null,
    actualPace: actualPaceEl.value || null,
    rpe: rpeEl.value ? parseInt(rpeEl.value, 10) : null,
    notes: notesEl.value || ''
  };

  runs[dateKey] = runObj;
  setStorage(runs);
  renderCalendar();

  // close modal AFTER we already stored dateKey
  closeModal();

  if (currentUser) {
    await saveRunToSupabase(currentUser.id, dateKey, runObj);
  }
});


  deleteBtn.addEventListener('click', async () => {
    if (!selectedDateKey) return;
    const runs = getStorage();
    delete runs[selectedDateKey];
    setStorage(runs);
    renderCalendar();
    closeModal();

    if (currentUser) {
      await deleteRunFromSupabase(currentUser.id, selectedDateKey);
    }
  });

  closeBtn.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e) => {
    if (e.target === modalBackdrop) closeModal();
  });

  prevMonthBtn.addEventListener('click', () => {
    currentMonth.setMonth(currentMonth.getMonth() - 1);
    renderCalendar();
  });

  nextMonthBtn.addEventListener('click', () => {
    currentMonth.setMonth(currentMonth.getMonth() + 1);
    renderCalendar();
  });

  function updateThisWeekStats(runs) {
    const now = new Date();
    const dayOfWeek = (now.getDay() + 6) % 7; // Mon=0
    const monday = new Date(now);
    monday.setDate(now.getDate() - dayOfWeek);

    let plannedKm = 0;
    let doneKm = 0;
    let runCount = 0;

    for (let i = 0; i < 7; i++) {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      const key = formatDateKey(d);
      const run = runs[key];
      if (!run) continue;

      if (run.plannedDistance) plannedKm += run.plannedDistance;
      if (run.actualDistance) {
        doneKm += run.actualDistance;
        runCount += 1;
      }
    }

    statsPlannedKm.textContent = plannedKm.toFixed(1);
    statsDoneKm.textContent = doneKm.toFixed(1);
    statsRuns.textContent = runCount;
  }

  // Supabase sync (using user.id as sync_id)
  async function loadFromSupabase(userId) {
    syncStatus.textContent = 'Loading...';
    try {
      const { data, error } = await supabase
        .from('runs')
        .select('date, data')
        .eq('sync_id', userId);

      if (error) {
        console.error('Supabase load error:', error);
        syncStatus.textContent = 'Error loading';
        alert('Supabase load error: ' + (error.message || JSON.stringify(error)));
        return;
      }

      // Merge Supabase data into local per-user storage
      const local = getStorage();
      data.forEach(row => {
        local[row.date] = row.data;
      });
      setStorage(local);

      renderCalendar();
      syncStatus.textContent = 'Loaded';
    } catch (e) {
      console.error('Unexpected load error:', e);
      syncStatus.textContent = 'Error';
      alert('Unexpected load error: ' + e.message);
    }
  }

  async function saveRunToSupabase(userId, dateKey, runObj) {
    syncStatus.textContent = 'Syncing...';
    try {
      const { error } = await supabase
        .from('runs')
        .upsert(
          { sync_id: userId, date: dateKey, data: runObj },
          { onConflict: 'sync_id,date' }
        );
      if (error) {
        console.error(error);
        syncStatus.textContent = 'Sync error';
      } else {
        syncStatus.textContent = 'Synced';
      }
    } catch (e) {
      console.error(e);
      syncStatus.textContent = 'Sync error';
    }
  }

  async function deleteRunFromSupabase(userId, dateKey) {
    syncStatus.textContent = 'Syncing...';
    try {
      const { error } = await supabase
        .from('runs')
        .delete()
        .eq('sync_id', userId)
        .eq('date', dateKey);
      if (error) {
        console.error(error);
        syncStatus.textContent = 'Sync error';
      } else {
        syncStatus.textContent = 'Synced';
      }
    } catch (e) {
      console.error(e);
      syncStatus.textContent = 'Sync error';
    }
  }

  function updateAuthUI() {
    if (currentUser) {
      authStatus.textContent = `Logged in as ${currentUser.email}`;
      logoutBtn.style.display = 'inline-block';
    } else {
      authStatus.textContent = 'Not logged in';
      logoutBtn.style.display = 'none';
    }
  }

  // Auth: login / signup / logout
  loginBtn.addEventListener('click', async () => {
    const email = loginEmailEl.value.trim();
    const password = loginPasswordEl.value;
    if (!email || !password) {
      alert('Enter email and password.');
      return;
    }

    authStatus.textContent = 'Logging in...';
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      console.error(error);
      authStatus.textContent = 'Login error';
      alert(error.message);
      return;
    }
    if (data && data.session && data.session.user) {
      currentUser = data.session.user;
      updateAuthUI();
      await loadFromSupabase(currentUser.id);
    }
  });

  signupBtn.addEventListener('click', async () => {
    const email = loginEmailEl.value.trim();
    const password = loginPasswordEl.value;
    if (!email || !password) {
      alert('Enter email and password to sign up.');
      return;
    }

    authStatus.textContent = 'Creating account...';
    const { data, error } = await supabase.auth.signUp({ email, password });
    if (error) {
      console.error(error);
      authStatus.textContent = 'Sign up error';
      alert(error.message);
      return;
    }

    alert('Account created. If email confirmation is required, confirm it, then log in.');
    authStatus.textContent = 'Account created. Log in.';
  });

  logoutBtn.addEventListener('click', async () => {
    await supabase.auth.signOut();
    currentUser = null;
    updateAuthUI();
    syncStatus.textContent = '';
    // logged out â†’ empty calendar
    renderCalendar();
  });

  // Check existing session on load
  (async () => {
    const { data, error } = await supabase.auth.getSession();
    if (!error && data.session && data.session.user) {
      currentUser = data.session.user;
      updateAuthUI();
      await loadFromSupabase(currentUser.id);
    } else {
      renderCalendar(); // logged out state: empty calendar
    }
  })();
</script>
</body>
</html>

